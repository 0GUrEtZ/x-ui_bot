# –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Å–∫–æ—Ä–æ–º –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –∏—Ö –ø–æ–¥–ø–∏—Å–∫–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü–∞ `subscription_expiry`:
- `email` (TEXT PRIMARY KEY) - email –∫–ª–∏–µ–Ω—Ç–∞
- `tg_id` (INTEGER) - Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `expiry_time` (INTEGER) - –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (Unix timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
- `last_updated` (INTEGER) - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
- `notified_days` (TEXT) - —Å–ø–∏—Å–æ–∫ –¥–Ω–µ–π, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: "7,3,1")

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **ExpiryNotifierService** (`internal/bot/services/expiry_notifier.go`)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –∫–∞–∂–¥—ã–π —á–∞—Å
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏

2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫** (`internal/bot/bot.go`)
   - `subscriptionSyncScheduler()` - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å
   - `syncSubscriptionExpiry()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∏–∑ 3X-UI
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞

3. **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** (`internal/bot/handlers_settings.go`)
   - `handleExtensionMenu()` - –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–ø—Ä–æ—Å–æ–≤

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í `config.yaml`:

```yaml
notifications:
  expiry_warning_days: [7, 3, 1]  # –ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

## –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ó–∞ 7 –¥–Ω–µ–π
```
üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ

üë§ –ê–∫–∫–∞—É–Ω—Ç: user@example.com
‚è∞ –ò—Å—Ç–µ–∫–∞–µ—Ç: 15.01.2024 12:00
üìÖ –û—Å—Ç–∞–ª–æ—Å—å: 7 –¥–Ω–µ–π

–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç —Å—Ä–æ–∫ –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏.
```

### –ó–∞ 3 –¥–Ω—è
```
‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç

üë§ –ê–∫–∫–∞—É–Ω—Ç: user@example.com
‚è∞ –ò—Å—Ç–µ–∫–∞–µ—Ç: 15.01.2024 12:00
üìÖ –û—Å—Ç–∞–ª–æ—Å—å: 3 –¥–Ω–µ–π

–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É!
```

### –ó–∞ 1 –¥–µ–Ω—å
```
üî¥ –°—Ä–æ—á–Ω–æ! –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞!

üë§ –ê–∫–∫–∞—É–Ω—Ç: user@example.com
‚è∞ –ò—Å—Ç–µ–∫–∞–µ—Ç: 15.01.2024 12:00
üìÖ –û—Å—Ç–∞–ª–æ—Å—å: –º–µ–Ω–µ–µ 1 –¥–Ω—è

‚ö†Ô∏è –î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
```

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–Ω–æ–ø–∫—É **"‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"**, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ (30/60/90 –¥–Ω–µ–π).

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ö–∞–∂–¥—ã–π —á–∞—Å –±–æ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ 3X-UI
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å `tg_id` –∏ –≤–∞–ª–∏–¥–Ω—ã–º —Å—Ä–æ–∫–æ–º –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `subscription_expiry`
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `expiry_time` –ø–æ–ª–µ `notified_days` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ö–∞–∂–¥—ã–π —á–∞—Å —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–Ω–∏
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:
  1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ —ç—Ç–æ—Ç –ø–æ—Ä–æ–≥
  2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  3. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `notified_days` (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ—Ä–æ–≥)

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω—é —Å –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∞ (30/60/90 –¥–Ω–µ–π)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä—è–µ—Ç/–æ—Ç–∫–ª–æ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏

## –£–º–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ê–≤—Ç–æ—Å–±—Ä–æ—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–ª–∏–ª –ø–æ–¥–ø–∏—Å–∫—É (–∏–∑–º–µ–Ω–∏–ª—Å—è `expiry_time`), –ø–æ–ª–µ `notified_days` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å—Ä–æ–∫–∞.

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
–î–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–ª–∏–ª –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–π —Å—Ä–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Å—Ç–∞–ª–æ—Å—å 5 –¥–Ω–µ–π, –ø—Ä–æ–¥–ª–∏–ª –Ω–∞ 2 –¥–Ω—è = 7 –¥–Ω–µ–π), —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π, –µ—Å–ª–∏ –æ–Ω–æ —É–∂–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Å—Ä–æ–∫–∞ —Å —Ç–∞–∫–∏–º –∂–µ `expiry_time`.

### –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
–ó–∞–ø–∏—Å–∏ –æ–± –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫–∞—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞, –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É–∫–∞–∑–∞–Ω—ã `expiry_warning_days`:

```go
// Start expiry notifier
if len(b.config.Notifications.ExpiryWarningDays) > 0 {
    ctx, cancel := context.WithCancel(context.Background())
    b.cancel = cancel
    go b.expiryNotifier.Start(ctx)
    go b.subscriptionSyncScheduler(ctx)
    b.logger.Info("Started expiry notifier and sync service")
}
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –£—Å–ø–µ—à–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏/–æ—Ç–ø—Ä–∞–≤–∫–∏

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
```
INFO: Starting expiry notifier service
INFO: Subscription sync scheduler started
INFO: Sent 7-day expiry warning to user 123456789 (user@example.com)
ERROR: Failed to sync subscriptions: connection timeout
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Go 1.24.6+
- SQLite (modernc.org/sqlite)
- Telego (Telegram Bot API)
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π 3X-UI API
